<!doctype html>
<html>
<head>
    <style type="text/css">
    body{
        background : #333;
    }

    canvas{
        
    }

    #canvasContainer{
        margin: auto;
        width:  800px;
        height: 400px;
        background-color:  #000;
        border : 3px solid #AAA;
    }

    h1 {
        text-align: center;
    }
    </style>
    <script>
        k_PortalWidth = 80;
        k_PortailHeight = 80;

        function Bonus()
        {
        }

        var directions = {{-1,-1},{-1,1},{1,1},{1,-1}};

        function Epicenter(id,pos)
        {
            // Epicenter id
            this.id = id;
            // Life time
            this.lifeTime = 0;
            // Minimal life time
            this.minLifeTime = 1000;

            // Position
            this.position = pos;

            // Array of position representing rust candidate
            this.rustCandidates = new Array();

            // 
            this.rustBonus = new Array();

            // Number of new rust cell per millisecond
            this.propagationSpeed = 10;

            // Constructor---------------------------------------------------


            this.addRustCandidate = function(portal,cellX,cellY)
            {
                if (portal.cells[cellX][cellY] == k_CellEmpty)
                {
                    this.rustCandidates.add(new Position(cellX,cellY));
                    return true;
                }
                return false;
            }

            this.makeRusty = function(portal, cellX, cellY)
            {
                if (portal.cells[cellX][cellY] == k_CellEmpty)
                {
                    portal.cells[cellX][cellY] = this.id;
                    //TODO : test this function
                    int elemIdx = this.rustCandidates.indexOf(new Position(cellX,cellY));
                    this.rustCandidates.splice(elemIdx,1);

                    for (int i=0; i < 4; i++)
                    {
                        var dir = directions[i];
                        this.addRustCandidate(cellX+dir[0],cellY+dir[1]);
                        return true;
                    }
                }
                return false;
            }

            this.update = function(portal,deltaTime)
            {
                this.lifeTime += this.deltaTime;
                var candidateFound = false;

                if (this.rustCandidates.length == 0)
                {
                    while (!candidateFound)
                    {
                        var dir = directions[random()*4];
                        var cellX = position.x+dir[0];
                        var cellY = position.y+dir[1]];
                        candidateFound = this.makeRusty(portal,cellX,cellY);
                    }
                    else if (portal.bonus.length != 0)
                    {
                        var weigthedCandidates = new Array();

                        // create a weigthed array for candidates
                        for (int c=0; c < rustCandidates.length; c++)
                        {
                            weigthedCandidates.push(c);
                            var candidatePos = rustCandidates[c];
                            for (int i=0; i < portal.bonus.length; i++)
                            {
                                var distance = portal.bonus.distance(candidatePos);
                                if (distance < 11)
                                {
                                    for (var w=0; w < distance/2; w++)
                                    {
                                        weigthedCandidates.push(c);
                                    }
                                }
                            }
                        }

                        var selectedCandidateId = weigthedCandidates[random()*weigthedCandidates.length];
                        var selectedCandidate = rustCandidates[selectedCandidateId];
                        this.makeRusty(portal, selectedCandidate.x, selectedCandidate.y);
                    }
                    else
                    {
                        var selectedCandidate = rustCandidates[random()*rustCandidates.length];
                        this.makeRusty(portal, selectedCandidate.x, selectedCandidate.y);
                    }
                }
            }

            this.isAlive = function ()
            {
                // No more rust candidate == no rust
                return ((this.lifeTime < minLifeTime) || (rustCandidates.length == 0));
            }


            this.construct();
        }


        function Position(x, y)
        {
            this.x = x;
            this.y = y;
        }

        k_CellInvisible = -2;
        k_CellEmpty = -1;

        function Portal()
        {
            this.cells = new Array();
            this.epicentres = new Array();

            this.construct = function();
            {
                for (var i=0; i < k_PortalWidth; i++)
                {
                    this.cells[i] = new Array();
                    for (var j=0; j < k_PortalWidth; j++)
                    {
                        this.cells[i][j] = k_CellEmpty;
                    }
                }
            }
        }

        function Game()
        {
            // Members---------------------------------------------------------
            this.time = 0;
            this.objectMode = 0;

            MODE_OIL = 0;
            MODE_DOG = 1;
            

            // Constructors----------------------------------------------------
            this.construct = function() {
            }

            // render game
            this.display = function() {
                
            }

            // Put the game on pause
            this.pause = function() {
                alert("Pause");
            }


            this.reset = function() {
                this.time = 0;
                alert("reset");
            }

            // Call constructor
            this.construct();
        }

        function init()
        {
            var g = new Game();
        }

    </script>
</head>

<body onload="init()">
    <div id="canvasContainer">
        <canvas width="800" height="400">
        </canvas>
        <h1>RusticPortail</h1>
    </div>
</body>
</html>